---
title: "Core Microbiome"
author: "David Elliott"
output: html_document
---


```{r}
library("phyloseq")

tidy_phyloseq <- function(my_phyloseq){
  # set ranks. 
  colnames(tax_table(my_phyloseq)) = c("Kingdom", "Phylum", "Class", "Order", "Family", "Genus", "Species")
  # fix taxa names
  tax_table(my_phyloseq)[,colnames(tax_table(my_phyloseq))] <- gsub(tax_table(my_phyloseq)[,colnames(tax_table(my_phyloseq))],pattern="[a-z]__",replacement="")
  # If NA in phylum position of taxonomy table then change it to "Unidentified"
  tax_table(my_phyloseq)[tax_table(my_phyloseq)[,"Phylum"]==NA,"Phylum"] <- "Unidentified"
  return(my_phyloseq)
}

# Kalahari bacteria
biom <- import_biom("data/kb/otu_table.biom",taxaPrefix="X")
map <- import_qiime_sample_data(mapfilename="data/kb/map.txt")
kb <- merge_phyloseq(biom, map)
kb <- tidy_phyloseq(kb)

### Holme Moss bacteria
biom <- import_biom("data/hb/otu_table.biom",taxaPrefix="X")
map <- import_qiime_sample_data(mapfilename="data/hb/map.txt")
tax_assignments <- read.delim("data/hb/tax.txt", header=F)
row.names(tax_assignments) <- tax_assignments$V1
taxonomy <- as.matrix(tax_assignments[2:8])
tax = tax_table(taxonomy)
hb <- merge_phyloseq(biom, map, tax)
hb <- tidy_phyloseq(hb)

### Holme Moss fungi
biom <- import_biom("data/hf/otu_table.biom",taxaPrefix="X")
map <- import_qiime_sample_data(mapfilename="data/hf/map.txt")
tax <- read.delim("data/hf/tax.txt")

tax_assignments <- read.delim("data/hf/tax.txt", header=F)
row.names(tax_assignments) <- tax_assignments$V1
taxonomy <- as.matrix(tax_assignments[2:8])
tax = tax_table(taxonomy)
hf <- merge_phyloseq(biom, map, tax)
hf <- tidy_phyloseq(hf)

kb
hb
hf

# convert OTU observations into relative abundance per sample
kb.rel <- transform_sample_counts(kb, function(x) 100*x/(sum(x)))
hb.rel <- transform_sample_counts(hb, function(x) 100*x/(sum(x)))
hf.rel <- transform_sample_counts(hf, function(x) 100*x/(sum(x)))

```


```{r core_OTU_list}
# finding the core OTUs 
expt <- kb.rel

# get the OTU table into a dataframe
otus <- as.data.frame(otu_table(expt))
# find mean and max occurrence for each OTU
otus$max <- apply(otus,1,max)
otus$mean <- apply(otus,1,mean)

# Now identify the core microbiome at the OTU level
# i.e. the way it is normally done

# OTUs which are present at >= 2% in any sample (max method in section below)
(core_otus_per_sample <- row.names(otus[otus$max >= 2,]) )
# OTUs which are present at >= 2% in the whole study (mean method in section below)
(core_otus_per_study <- row.names(otus[otus$mean >= 2,]) )

# Now do same at any taxonomic rank - not the OTU clustering rank
# tax_glom does not always pick the most abundant OTU in the classification
# Therefore need to specifically check for the most abundant OTU 

core_otus_glom <- c()
rank <- "Phylum"
method <- "mean" 
for (rank in rank_names(expt)[2:6]) {
  expt.glom <- tax_glom(expt,rank)
  glom_otus <- as.data.frame(otu_table(expt.glom))
  glom_otus$stat <- apply(glom_otus,1,method)
  # make a list of the taxa meeting the abundance criteria
  glom_rank_candidates <- row.names(glom_otus[glom_otus$stat >= 2,])
  # identify the taxonomy of the candidates
  glom_rank_taxonomy <- tax_table(expt.glom)[glom_rank_candidates,rank]
  # identify the most abundant OTU within the identified taxonomic group, and add it to the list
  for (candidate in glom_rank_taxonomy) {
    OTUs_in_taxonomic_group <- tax_table(expt)[,rank] == as.character(candidate)
    most_abundant_OTU <- names(which.max(taxa_sums(expt)[as.vector(OTUs_in_taxonomic_group)]))
    core_otus_glom <- c(core_otus_glom,most_abundant_OTU)
  }
}
(core_otus_glom <- unique(core_otus_glom) )

# identify the core OTUs which were identified because of their contribution to a 
# higher taxonomic rank:
( core_extras <- core_otus_glom[!core_otus_glom%in%core_otus_per_study] )

```
